<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ - ç»ˆæç‰ˆ</title>
    <style>
        :root {
            --primary: #3498db;     /* ä¸»è‰²è°ƒï¼šè“ */
            --success: #2ecc71;     /* æˆåŠŸï¼šç»¿ */
            --danger: #e74c3c;      /* å¤±è´¥ï¼šçº¢ */
            --text: #2c3e50;        /* æ–‡æœ¬è‰² */
            --bg: #f4f6f9;          /* èƒŒæ™¯ç° */
            --card-bg: #ffffff;
            --sidebar-width: 250px; /* å·¦ä¾§æ å®½åº¦ */
            --grid-width: 280px;    /* å³ä¾§ç½‘æ ¼å®½åº¦ */
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* === å¸ƒå±€å®¹å™¨ === */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* 1. å·¦ä¾§ï¼šæ¨¡å—å¯¼èˆªæ  */
        .sidebar-left {
            width: var(--sidebar-width);
            background: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 20;
            transition: transform 0.3s ease;
        }
        .sidebar-header {
            padding: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 1px solid #34495e;
            text-align: center;
            background: #1a252f;
        }
        .module-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex: 1;
        }
        .module-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #34495e;
            transition: 0.2s;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .module-item:hover { background: #34495e; }
        .module-item.active { 
            background: var(--primary); 
            color: white;
            font-weight: bold;
        }
        .badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        /* 2. ä¸­é—´ï¼šç­”é¢˜ä¸»åŒºåŸŸ */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .quiz-card {
            background: var(--card-bg);
            width: 100%;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 40px;
            margin-bottom: 100px;
        }

        /* é¢˜ç›®å¤´éƒ¨ä¿¡æ¯ */
        .q-meta { display: flex; justify-content: space-between; margin-bottom: 20px; color: #7f8c8d; font-size: 0.9rem; }
        .tag-type { background: var(--primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; vertical-align: middle; }
        
        .q-text { font-size: 1.2rem; line-height: 1.6; margin-bottom: 30px; font-weight: 500; }

        /* é€‰é¡¹æ ·å¼ */
        .options-group { display: flex; flex-direction: column; gap: 15px; }
        .option-item {
            display: flex;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            align-items: flex-start;
        }
        .option-item:hover { border-color: #bdc3c7; background: #f8f9fa; }
        .opt-char { font-weight: bold; margin-right: 15px; min-width: 25px; }
        .opt-content { flex: 1; line-height: 1.4; }

        /* é€‰é¡¹çŠ¶æ€ */
        .option-item.selected { border-color: var(--primary); background: #eaf2f8; }
        .option-item.correct { border-color: var(--success); background: #e8f8f5; color: #155724; }
        .option-item.wrong { border-color: var(--danger); background: #fdedec; color: #721c24; }

        /* ç»“æœåé¦ˆåŒº */
        .feedback-area {
            margin-top: 25px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            animation: fadeIn 0.3s;
        }
        .feedback-area.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* åº•éƒ¨å›ºå®šæ§åˆ¶æ¡ */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: var(--sidebar-width);
            right: var(--grid-width);
            background: white;
            padding: 15px 30px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 600;
        }
        .btn-prev { background: transparent; border: 1px solid #ddd; color: #666; }
        .btn-next { background: var(--primary); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* === é”™é¢˜æ¨¡å¼å¼€å…³ === */
        .toggle-mode { display: flex; align-items: center; gap: 10px; font-size: 14px; color: #666; cursor: pointer; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--danger); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* 3. å³ä¾§ï¼šç­”é¢˜ç½‘æ ¼ */
        .sidebar-right {
            width: var(--grid-width);
            background: white;
            border-left: 1px solid #e1e4e8;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .grid-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; color: #2c3e50; }
        .grid-stats { padding: 10px 15px; background: #f8f9fa; font-size: 0.85rem; display: flex; gap: 10px; flex-wrap: wrap; }
        .stat-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        
        .grid-box {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            align-content: start;
        }
        
        /* æ–°å¢ï¼šç½‘æ ¼åº•éƒ¨é‡ç½®åŒº */
        .grid-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            background: #fcfcfc;
            text-align: center;
        }
        .btn-danger-outline {
            background: white;
            border: 1px solid var(--danger);
            color: var(--danger);
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-danger-outline:hover { background: #fdedec; }

        .grid-num {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f3f5;
            border-radius: 6px;
            font-size: 0.8rem;
            color: #7f8c8d;
            cursor: pointer;
            transition: 0.2s;
            border: 2px solid transparent;
        }
        .grid-num:hover { transform: scale(1.1); }
        .grid-num.active { border-color: var(--primary); color: var(--primary); font-weight: bold; background: white; }
        .grid-num.correct { background: var(--success); color: white; border-color: var(--success); }
        .grid-num.wrong { background: var(--danger); color: white; border-color: var(--danger); }

        /* === ç§»åŠ¨ç«¯é€‚é… === */
        .mobile-top-bar { display: none; }
        .mobile-fab { display: none; }

        @media (max-width: 900px) {
            body { flex-direction: column; }
            .mobile-top-bar { display: flex; align-items: center; justify-content: space-between; height: 50px; background: #2c3e50; color: white; padding: 0 15px; flex-shrink: 0; }
            .menu-icon { font-size: 24px; cursor: pointer; }
            .sidebar-left { position: fixed; top: 0; bottom: 0; left: 0; transform: translateX(-100%); box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
            .sidebar-left.open { transform: translateX(0); }
            
            /* ç§»åŠ¨ç«¯åº•éƒ¨æ§åˆ¶æ  */
            .bottom-bar { left: 0; right: 0; padding: 10px; justify-content: space-between; font-size: 0.9rem; }
            .btn { padding: 8px 15px; font-size: 0.9rem; }
            /* ç§»åŠ¨ç«¯å¼€å…³æ–‡å­—éšè— */
            .toggle-text { display: none; }

            .sidebar-right { position: fixed; bottom: 0; left: 0; width: 100%; height: 70vh; transform: translateY(110%); transition: transform 0.3s; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 100; }
            .sidebar-right.open { transform: translateY(0); }
            
            .mobile-fab { display: flex; position: fixed; bottom: 80px; right: 20px; width: 45px; height: 45px; background: var(--primary); color: white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); align-items: center; justify-content: center; font-size: 20px; z-index: 50; cursor: pointer; }
        }
    </style>
</head>
<body>

    <div class="mobile-top-bar">
        <span class="menu-icon" onclick="toggleLeftMenu()">â˜°</span>
        <span id="mobileTitle">åˆ·é¢˜ç¥å™¨</span>
        <span style="width:24px"></span>
    </div>

    <div class="app-container">
        <div class="sidebar-left" id="leftMenu">
            <div class="sidebar-header">é¢˜åº“æ¨¡å—</div>
            <ul class="module-list" id="moduleList"></ul>
        </div>

        <div class="main-content" onclick="closeMenus()">
            <div class="quiz-card">
                <div class="q-meta">
                    <span>
                        <span class="tag-type" id="qType">å•é€‰</span>
                        <span style="margin-left:10px; color:#aaa">åŸé¢˜å·: <span id="qRealId">0</span></span>
                    </span>
                    <span><span id="qIndex">1</span> / <span id="qTotal">80</span></span>
                </div>

                <div class="q-text" id="qContent">é¢˜ç›®åŠ è½½ä¸­...</div>

                <div class="options-group" id="optionsArea"></div>

                <div class="feedback-area" id="feedbackArea"></div>
            </div>
        </div>

        <div class="bottom-bar">
            <button class="btn btn-prev" onclick="changeQuestion(-1)">ä¸Šä¸€é¢˜</button>
            
            <div class="toggle-mode">
                <label class="switch">
                    <input type="checkbox" id="wrong-mode-toggle" onchange="toggleWrongMode()">
                    <span class="slider"></span>
                </label>
                <span class="toggle-text">åªçœ‹é”™é¢˜</span>
            </div>

            <button class="btn btn-next" id="actionBtn" onclick="handleAction()">æäº¤ç­”æ¡ˆ</button>
        </div>

        <div class="sidebar-right" id="rightGrid">
            <div class="grid-header" onclick="toggleRightGrid()">
                ç­”é¢˜å¡ 
                <span style="float:right; font-size:12px; font-weight:normal; color:#999; margin-top:3px">(ç‚¹å‡»æ”¶èµ·)</span>
            </div>
            <div class="grid-stats">
                <div><span class="stat-dot" style="background:var(--primary)"></span>å½“å‰</div>
                <div><span class="stat-dot" style="background:#f1f3f5; border:1px solid #ccc"></span>æœªåš</div>
                <div><span class="stat-dot" style="background:var(--success)"></span>æ­£ç¡®</div>
                <div><span class="stat-dot" style="background:var(--danger)"></span>é”™è¯¯</div>
            </div>
            <div class="grid-box" id="gridContent"></div>
            
            <div class="grid-footer">
                <button class="btn-danger-outline" onclick="resetCurrentModule()">ğŸ—‘ï¸ é‡ç½®æœ¬ç« è¿›åº¦</button>
            </div>
        </div>
    </div>

    <div class="mobile-fab" onclick="toggleRightGrid()">â–¦</div>

    <script src="quiz_data.js"></script>

    <script>
        // ================== å…¨å±€å˜é‡ ==================
        let currentModuleKey = null; // å½“å‰é€‰ä¸­çš„æ¨¡å—å
        let allQuestions = [];       // å½“å‰æ¨¡å—æ‰€æœ‰é¢˜ç›®
        let displayQuestions = [];   // å½“å‰æ˜¾ç¤ºçš„é¢˜ç›®
        let currentIndex = 0;        
        
        let userHistory = JSON.parse(localStorage.getItem('quiz_history') || '{}');
        let wrongBook = JSON.parse(localStorage.getItem('wrong_book_ids') || '[]');
        
        let isWrongMode = false;

        // ================== åˆå§‹åŒ– ==================
        window.onload = function() {
            if (typeof QUIZ_DATA === 'undefined') {
                alert("æœªåŠ è½½åˆ°æ•°æ®ï¼è¯·å…ˆè¿è¡Œ converter.py ç”Ÿæˆ quiz_data.js");
                return;
            }
            initSidebar();
            const firstKey = Object.keys(QUIZ_DATA)[0];
            if(firstKey) loadModule(firstKey);
        };

        // 1. åˆå§‹åŒ–ä¾§è¾¹æ 
        function initSidebar() {
            const list = document.getElementById('moduleList');
            list.innerHTML = "";
            Object.keys(QUIZ_DATA).forEach((key) => {
                const count = QUIZ_DATA[key].length;
                const li = document.createElement('li');
                li.className = 'module-item';
                li.innerHTML = `<span>${key}</span> <span class="badge">${count}</span>`;
                li.onclick = (e) => {
                    e.stopPropagation();
                    loadModule(key);
                };
                list.appendChild(li);
            });
        }

        // 2. åŠ è½½æŒ‡å®šæ¨¡å—
        function loadModule(key) {
            currentModuleKey = key;
            allQuestions = QUIZ_DATA[key];
            
            document.querySelectorAll('.module-item').forEach(el => {
                el.classList.toggle('active', el.innerText.includes(key));
            });
            document.getElementById('mobileTitle').innerText = key.split(' ')[0] + "..";

            filterQuestions();
            closeMenus();
        }

        // æ ¸å¿ƒï¼šç­›é€‰é€»è¾‘
        function filterQuestions() {
            if (isWrongMode) {
                displayQuestions = allQuestions.filter(q => wrongBook.includes(q.orig_id));
                if (displayQuestions.length === 0) {
                    alert("ğŸ‰ æœ¬æ¨¡å—æ²¡æœ‰é”™é¢˜è®°å½•ï¼Œåˆ‡æ¢å›æ™®é€šæ¨¡å¼ã€‚");
                    document.getElementById('wrong-mode-toggle').checked = false;
                    isWrongMode = false;
                    displayQuestions = allQuestions;
                }
            } else {
                displayQuestions = allQuestions;
            }
            currentIndex = 0;
            renderQuestion();
            renderGrid();
        }

        // 3. æ¸²æŸ“é¢˜ç›®
        function renderQuestion() {
            if (displayQuestions.length === 0) return;
            
            const q = displayQuestions[currentIndex];
            const record = userHistory[q.orig_id]; 

            document.getElementById('qType').innerText = q.type;
            document.getElementById('qRealId').innerText = q.orig_id || q.id;
            document.getElementById('qIndex').innerText = currentIndex + 1;
            document.getElementById('qTotal').innerText = displayQuestions.length;
            document.getElementById('qContent').innerText = q.question;

            const optArea = document.getElementById('optionsArea');
            optArea.innerHTML = "";
            
            q.options.forEach(optStr => {
                const char = optStr.charAt(0);
                const div = document.createElement('div');
                div.className = 'option-item';
                div.innerHTML = `<span class="opt-char">${char}</span> <span class="opt-content">${optStr.substring(2)}</span>`;
                div.dataset.val = char;
                
                if (record) {
                    div.style.cursor = 'default';
                    if (q.answer.includes(char)) div.classList.add('correct');
                    if (record.choice.includes(char) && !q.answer.includes(char)) div.classList.add('wrong');
                } else {
                    div.onclick = () => selectOption(div, q.type);
                }
                optArea.appendChild(div);
            });

            const btn = document.getElementById('actionBtn');
            const feedback = document.getElementById('feedbackArea');
            
            if (record) {
                btn.innerText = (currentIndex === displayQuestions.length - 1) ? "æœ¬é¡µç»“æŸ" : "ä¸‹ä¸€é¢˜";
                btn.classList.remove('btn-next'); 
                btn.style.background = "#95a5a6"; 
                btn.disabled = false;
                
                const isRight = record.isCorrect;
                feedback.className = 'feedback-area show';
                feedback.style.background = isRight ? '#e8f8f5' : '#fdedec';
                feedback.style.border = isRight ? '1px solid #2ecc71' : '1px solid #e74c3c';
                feedback.innerHTML = isRight 
                    ? `<strong style="color:#27ae60">âœ… å›ç­”æ­£ç¡®</strong>`
                    : `<strong style="color:#c0392b">âŒ å›ç­”é”™è¯¯</strong><br>æ­£ç¡®ç­”æ¡ˆï¼š${q.answer}`;
            } else {
                btn.innerText = "æäº¤ç­”æ¡ˆ";
                btn.classList.add('btn-next');
                btn.style.background = ""; 
                btn.disabled = true; 
                feedback.className = 'feedback-area'; 
            }
            updateGridActive();
        }

        // 4. é€‰ä¸­é€»è¾‘
        function selectOption(el, type) {
            const q = displayQuestions[currentIndex];
            if (userHistory[q.orig_id]) return;

            if (type === 'å¤šé€‰é¢˜') {
                el.classList.toggle('selected');
            } else {
                const siblings = el.parentElement.children;
                for(let sib of siblings) sib.classList.remove('selected');
                el.classList.add('selected');
            }

            const hasSelected = document.querySelectorAll('.option-item.selected').length > 0;
            document.getElementById('actionBtn').disabled = !hasSelected;
        }

        // 5. æäº¤/ä¸‹ä¸€é¢˜
        function handleAction() {
            const q = displayQuestions[currentIndex];
            const record = userHistory[q.orig_id];

            if (record) {
                if (currentIndex < displayQuestions.length - 1) {
                    changeQuestion(1);
                } else {
                    alert("æœ¬åˆ—è¡¨ç»ƒä¹ ç»“æŸï¼");
                }
                return;
            }

            const selected = document.querySelectorAll('.option-item.selected');
            if (selected.length === 0) return;

            const userChoice = Array.from(selected).map(el => el.dataset.val).sort().join('');
            const isCorrect = (userChoice === q.answer);
            const globalId = q.orig_id;

            if (!isCorrect) {
                if (!wrongBook.includes(globalId)) {
                    wrongBook.push(globalId);
                    saveWrongBook();
                }
            } else {
                if (isWrongMode) {
                    wrongBook = wrongBook.filter(id => id !== globalId);
                    saveWrongBook();
                }
            }

            userHistory[globalId] = { choice: userChoice, isCorrect: isCorrect };
            localStorage.setItem('quiz_history', JSON.stringify(userHistory));

            renderQuestion();
            renderGrid();
        }

        // === æ–°å¢ï¼šé‡ç½®å½“å‰æ¨¡å— ===
        function resetCurrentModule() {
            if(!confirm("âš ï¸ ç¡®å®šè¦é‡ç½®æœ¬ç« èŠ‚çš„æ‰€æœ‰è¿›åº¦å—ï¼Ÿ\n\nè¿™å°†ä¼šæ¸…ç©ºæœ¬ç« æ‰€æœ‰é¢˜ç›®çš„åšé¢˜è®°å½•ï¼ˆåŒ…æ‹¬é”™é¢˜æœ¬ä¸­çš„è®°å½•ï¼‰ï¼Œä¸€æ—¦æ“ä½œæ— æ³•æ’¤é”€ã€‚")) {
                return;
            }

            // è·å–å½“å‰æ¨¡å—æ‰€æœ‰é¢˜ç›®çš„ orig_id
            const currentIds = allQuestions.map(q => q.orig_id);

            // 1. æ¸…é™¤åšé¢˜è®°å½•
            currentIds.forEach(id => {
                delete userHistory[id];
            });
            localStorage.setItem('quiz_history', JSON.stringify(userHistory));

            // 2. æ¸…é™¤é”™é¢˜æœ¬è®°å½• (å¦‚æœæƒ³ä¿ç•™é”™é¢˜æœ¬ï¼Œå¯ä»¥æ³¨é‡Šæ‰è¿™éƒ¨åˆ†ï¼Œä½†é€šå¸¸é‡ç½®æ„å‘³ç€é‡æ¥)
            wrongBook = wrongBook.filter(id => !currentIds.includes(id));
            saveWrongBook();

            // 3. åˆ·æ–°ç•Œé¢
            if(isWrongMode) {
                // å¦‚æœåœ¨é”™é¢˜æ¨¡å¼ä¸‹é‡ç½®ï¼Œå› ä¸ºé”™é¢˜æ²¡äº†ï¼Œä¼šè‡ªåŠ¨åˆ‡å›æ™®é€šæ¨¡å¼
                filterQuestions(); 
            } else {
                // æ™®é€šæ¨¡å¼ä¸‹ï¼Œä»…åˆ·æ–°çŠ¶æ€
                renderQuestion();
                renderGrid();
            }
            
            // æ‰‹æœºç«¯è‡ªåŠ¨å…³é—­ç½‘æ ¼ä»¥ä¾¿çœ‹åˆ°ç»“æœ
            if(window.innerWidth <= 900) toggleRightGrid();
            
            alert("âœ… æœ¬ç« è¿›åº¦å·²é‡ç½®ï¼Œæ‚¨å¯ä»¥é‡æ–°å¼€å§‹äº†ï¼");
        }

        function saveWrongBook() {
            localStorage.setItem('wrong_book_ids', JSON.stringify(wrongBook));
        }

        function toggleWrongMode() {
            isWrongMode = document.getElementById('wrong-mode-toggle').checked;
            filterQuestions();
        }

        function changeQuestion(offset) {
            const newIndex = currentIndex + offset;
            if (newIndex >= 0 && newIndex < displayQuestions.length) {
                currentIndex = newIndex;
                renderQuestion();
            }
        }

        function jumpTo(idx) {
            currentIndex = idx;
            renderQuestion();
            if (window.innerWidth <= 900) toggleRightGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('gridContent');
            grid.innerHTML = "";
            displayQuestions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'grid-num';
                div.innerText = isWrongMode ? q.orig_id : (idx + 1);
                const record = userHistory[q.orig_id];
                if (record) {
                    div.classList.add(record.isCorrect ? 'correct' : 'wrong');
                }
                div.onclick = () => jumpTo(idx);
                grid.appendChild(div);
            });
            updateGridActive();
        }

        function updateGridActive() {
            const nums = document.querySelectorAll('.grid-num');
            nums.forEach((n, i) => {
                if (i === currentIndex) {
                    n.classList.add('active');
                    n.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    n.classList.remove('active');
                }
            });
        }

        function toggleLeftMenu() {
            document.getElementById('leftMenu').classList.toggle('open');
            document.getElementById('rightGrid').classList.remove('open');
        }
        function toggleRightGrid() {
            document.getElementById('rightGrid').classList.toggle('open');
            document.getElementById('leftMenu').classList.remove('open');
        }
        function closeMenus() {
            document.getElementById('leftMenu').classList.remove('open');
            document.getElementById('rightGrid').classList.remove('open');
        }
    </script>
</body>
</html>